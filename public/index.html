<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunshine Hotel Menu</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        
        /* Tab Navigation */
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button {
            padding: 10px 20px; cursor: pointer; border: none; background: #ddd; 
            margin: 5px; font-size: 16px; border-radius: 5px;
        }
        .tab-button.active { background: #ff9800; color: white; }

        /* Menu Grid */
        .menu-group { display: none; }
        .menu-group.active { display: block; }
        
        .category-section { margin-bottom: 30px; }
        .category-title { 
            border-bottom: 2px solid #ff9800; padding-bottom: 5px; 
            color: #ff9800; font-size: 1.5em; margin-bottom: 15px; 
        }

        .items-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .menu-item {
            background: white; padding: 15px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .item-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .item-price { color: #28a745; }
        .item-desc { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .item-img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }
        .sold-out-badge {
            position: absolute; top: 10px; right: 10px;
            background-color: #dc3545; color: white;
            padding: 4px 8px; border-radius: 4px;
            font-size: 12px; font-weight: bold;
            z-index: 10;
        }
        .menu-item.sold-out { opacity: 0.7; }
        
        .add-btn {
            background-color: #28a745; color: white; border: none; padding: 8px;
            border-radius: 4px; cursor: pointer; width: 100%; margin-top: auto;
        }
        .add-btn:hover { background-color: #218838; }
        .add-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Cart Styles */
        .cart-toggle {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background-color: #ff9800; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .cart-count {
            position: absolute; top: 0; right: 0; background: red; color: white;
            font-size: 12px; padding: 2px 6px; border-radius: 50%;
        }
        .cart-overlay {
            position: fixed; top: 0; right: -350px; width: 300px; height: 100%;
            background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            transition: right 0.3s ease; z-index: 1001; padding: 20px;
            display: flex; flex-direction: column;
        }
        .cart-overlay.open { right: 0; }
        .cart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .close-cart { cursor: pointer; font-size: 24px; }
        .cart-items { flex-grow: 1; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        .cart-controls button { background: #ddd; border: none; width: 25px; height: 25px; cursor: pointer; border-radius: 4px; }
        .checkout-btn { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; }

        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

        /* Receipt Modal Styles */
        .receipt-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .receipt-modal.open { display: flex; }
        .receipt-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 380px;
            width: 90%;
            margin: auto;
        }
        .receipt-box {
            border: 1px solid #eee;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
            background: #fff;
            color: #333;
        }
        .receipt-header { text-align: center; margin-bottom: 15px; }
        .receipt-header h2 { margin: 0; font-size: 1.4em; text-transform: uppercase; letter-spacing: 1px; }
        .receipt-header p { margin: 5px 0; font-size: 0.8em; color: #666; }
        .receipt-divider { border-top: 1px dashed #333; margin: 15px 0; }
        .receipt-item { display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9em; }
        .receipt-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; margin-top: 10px; }
        .receipt-footer { text-align: center; margin-top: 20px; font-size: 0.8em; color: #555; }
        .receipt-actions { margin-top: 20px; display: flex; gap: 10px; }
        .receipt-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-download { background-color: #007bff; color: white; }
        .btn-close { background-color: #6c757d; color: white; }
        .btn-share { background-color: #28a745; color: white; }

        @media print {
            body * { visibility: hidden; }
            #receipt-body, #receipt-body * { visibility: visible; }
            #receipt-modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: none; display: block; }
            .receipt-content { box-shadow: none; border: none; width: 100%; max-width: none; }
            .receipt-actions { display: none; }
            .cart-overlay, .cart-toggle { display: none; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

    <h1>Sunshine Hotel Menu</h1>

    <div class="tabs" id="tabs"></div>
    <div id="menu-container"></div>

    <!-- Cart UI -->
    <div class="cart-toggle" onclick="toggleCart()">
        ðŸ›’ <span class="cart-count" id="cart-count">0</span>
    </div>

    <div class="cart-overlay" id="cart-overlay">
        <div class="cart-header">
            <h2>Your Order</h2>
            <span class="close-cart" onclick="toggleCart()">&times;</span>
        </div>
        <div class="cart-items" id="cart-items">
            <p>Your cart is empty.</p>
        </div>
        <div style="border-top: 1px solid #eee; padding-top: 10px;">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="customer-name" placeholder="Your Name">
            </div>
            <div class="form-group">
                <label>Location</label>
                <select id="location-select" onchange="handleLocationChange()">
                    <option value="">Select Location</option>
                    <option value="Room">Room</option>
                    <option value="Lobby Bar">Lobby Bar</option>
                    <option value="Restaurant">Restaurant</option>
                    <option value="Kenny's Sports Bar">Kenny's Sports Bar</option>
                    <option value="Tropics Bar">Tropics Bar</option>
                    <option value="Cabana">Cabana</option>
                    <option value="Eric's Meeting Room">Eric's Meeting Room</option>
                </select>
            </div>
            <div class="form-group" id="location-number-group" style="display:none;">
                <label id="location-number-label">Number</label>
                <input type="text" id="location-number">
            </div>
        </div>
        <div class="cart-footer">
            <h3>Total: <span id="cart-total">â‚¦0.00</span></h3>
            <button class="checkout-btn" onclick="checkout()">Checkout</button>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="receipt-modal">
        <div class="receipt-content">
            <div id="receipt-body" class="receipt-box"></div>
            <div class="receipt-actions">
                <button class="receipt-btn btn-download" onclick="downloadReceipt()">Download</button>
                <button class="receipt-btn btn-share" onclick="shareReceipt()">Share</button>
                <button class="receipt-btn btn-close" onclick="closeReceiptModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const state = { menu: [], cart: [] };

        const menuGroups = {
            "Food": ["Breakfast", "Appetizers", "Salads", "Specials", "Soups", "Main", "Pasta", "Burgers & Sandwiches", "Sides", "Desserts"],
            "Non-Alcoholic Drinks": ["Mocktails", "Smoothies", "Milkshakes", "Coffee", "Tea", "Water", "Soft Drinks", "Juices"],
            "Alcoholic Drinks": ["Cocktails", "Beers", "Aperitifs", "Rum", "Gin & Vodka", "Liquor", "Tequila", "Cognac & Brandy", "Whisky", "Wine", "Champagne"],
            "Other": ["Cigarettes"]
        };

        async function loadMenu() {
            try {
                let response = await fetch('/api/menu');
                if(!response.ok) response = await fetch('menu.json');
                state.menu = await response.json();
                renderMenu(state.menu);
            } catch (error) {
                console.error('Error loading menu:', error);
                document.getElementById('menu-container').innerHTML = '<p>Error loading menu.</p>';
            }
        }

        function renderMenu(menuData) {
            const tabsContainer = document.getElementById('tabs');
            const menuContainer = document.getElementById('menu-container');
            tabsContainer.innerHTML = '';
            menuContainer.innerHTML = '';
            
            let isFirstTab = true;

            for (const [groupName, categories] of Object.entries(menuGroups)) {
                const btn = document.createElement('button');
                btn.className = `tab-button ${isFirstTab ? 'active' : ''}`;
                btn.innerText = groupName;
                btn.onclick = () => openTab(groupName);
                tabsContainer.appendChild(btn);

                const groupDiv = document.createElement('div');
                groupDiv.id = groupName;
                groupDiv.className = `menu-group ${isFirstTab ? 'active' : ''}`;

                const groupItems = menuData.filter(item => categories.includes(item.category));

                if (groupItems.length === 0) {
                    groupDiv.innerHTML = `<p>No items available.</p>`;
                } else {
                    categories.forEach(category => {
                        const categoryItems = groupItems.filter(item => item.category === category);
                        if (categoryItems.length > 0) {
                            const catSection = document.createElement('div');
                            catSection.className = 'category-section';
                            catSection.innerHTML = `<div class="category-title">${category}</div>`;
                            
                            const grid = document.createElement('div');
                            grid.className = 'items-grid';
                            
                            categoryItems.forEach(item => {
                                const itemEl = document.createElement('div');
                                itemEl.className = `menu-item ${item.soldOut ? 'sold-out' : ''}`;
                                itemEl.innerHTML = `
                                    ${item.soldOut ? '<span class="sold-out-badge">Sold Out</span>' : ''}
                                    ${item.image ? `<img src="${item.image}" alt="${item.name}" class="item-img">` : ''}
                                    <div class="item-header">
                                        <span>${item.name}</span>
                                        <span class="item-price">â‚¦${item.price.toLocaleString()}</span>
                                    </div>
                                    <div class="item-desc">${item.desc}</div>
                                    ${!item.soldOut ? `<button class="add-btn" onclick="addToCart(${item.id})">Add to Cart</button>` : '<button class="add-btn" disabled>Sold Out</button>'}
                                `;
                                grid.appendChild(itemEl);
                            });
                            catSection.appendChild(grid);
                            groupDiv.appendChild(catSection);
                        }
                    });
                }
                menuContainer.appendChild(groupDiv);
                isFirstTab = false;
            }
        }

        function openTab(groupName) {
            document.querySelectorAll('.menu-group').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(groupName).classList.add('active');
            Array.from(document.querySelectorAll('.tab-button')).find(b => b.innerText === groupName).classList.add('active');
        }

        function toggleCart() {
            document.getElementById('cart-overlay').classList.toggle('open');
        }

        function addToCart(id) {
            const item = state.menu.find(i => i.id == id);
            if (!item) return;
            const existing = state.cart.find(c => c.id == id);
            if (existing) existing.qty++;
            else state.cart.push({ ...item, qty: 1 });
            renderCart();
            document.getElementById('cart-overlay').classList.add('open');
        }

        function changeQty(id, delta) {
            const item = state.cart.find(c => c.id == id);
            if (!item) return;
            item.qty += delta;
            if (item.qty <= 0) state.cart = state.cart.filter(c => c.id != id);
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const countEl = document.getElementById('cart-count');
            const totalEl = document.getElementById('cart-total');
            
            container.innerHTML = '';
            let total = 0;
            let count = 0;

            if (state.cart.length === 0) {
                container.innerHTML = '<p>Your cart is empty.</p>';
            } else {
                state.cart.forEach(item => {
                    total += item.price * item.qty;
                    count += item.qty;
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>â‚¦${item.price.toLocaleString()} x ${item.qty}</small>
                        </div>
                        <div class="cart-controls">
                            <button onclick="changeQty(${item.id}, -1)">-</button>
                            <span>${item.qty}</span>
                            <button onclick="changeQty(${item.id}, 1)">+</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            countEl.innerText = count;
            totalEl.innerText = 'â‚¦' + total.toLocaleString();
        }

        function handleLocationChange() {
            const loc = document.getElementById('location-select').value;
            const group = document.getElementById('location-number-group');
            const label = document.getElementById('location-number-label');
            const input = document.getElementById('location-number');
            
            if (!loc || loc === "Eric's Meeting Room") {
                group.style.display = 'none';
                input.value = '';
            } else {
                group.style.display = 'block';
                if (loc === 'Room') {
                    label.innerText = 'Room Number';
                    input.placeholder = 'Enter Room Number';
                } else {
                    label.innerText = 'Table Number';
                    input.placeholder = 'Enter Table Number';
                }
            }
        }

        async function checkout() {
            if (state.cart.length === 0) return alert('Cart is empty');
            
            const name = document.getElementById('customer-name').value.trim();
            if (!name) return alert('Please enter your name');

            const locType = document.getElementById('location-select').value;
            if (!locType) return alert('Please select a location');

            let location = locType;
            if (locType !== "Eric's Meeting Room") {
                const num = document.getElementById('location-number').value.trim();
                if (!num) return alert(`Please enter the ${locType === 'Room' ? 'Room' : 'Table'} Number`);
                location = `${locType} ${num}`;
            }

            const total = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            const confirmMsg = `Confirm Order Details:\n\nName: ${name}\nLocation: ${location}\nTotal: â‚¦${total.toLocaleString()}\n\nProceed with order?`;
            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: state.cart, customer: { name }, total, location })
                });
                const data = await res.json();
                if (data.id) {
                    alert('Order placed successfully! Order ID: ' + data.id);
                    
                    printReceipt({
                        id: data.id,
                        items: state.cart,
                        customer: { name },
                        total: total,
                        location: location,
                        createdAt: new Date().toISOString()
                    });

                    state.cart = [];
                    renderCart();
                    toggleCart();
                    // Reset form
                    document.getElementById('customer-name').value = '';
                    document.getElementById('location-select').value = '';
                    handleLocationChange();
                } else {
                    alert('Error placing order');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to place order');
            }
        }

        function printReceipt(order) {
            const modal = document.getElementById('receipt-modal');
            const body = document.getElementById('receipt-body');
            
            body.innerHTML = `
                <div class="receipt-header">
                    <h2>Sunshine Hotel</h2>
                    <p>Order Receipt</p>
                    <p>${new Date(order.createdAt).toLocaleString()}</p>
                </div>
                <div class="receipt-divider"></div>
                <div style="font-size: 0.9em;">
                    <p><strong>Order ID:</strong> #${order.id}</p>
                    <p><strong>Customer:</strong> ${order.customer.name}</p>
                    <p><strong>Location:</strong> ${order.location}</p>
                </div>
                <div class="receipt-divider"></div>
                <div>
                    ${order.items.map(i => `
                        <div class="receipt-item">
                            <span>${i.qty}x ${i.name}</span>
                            <span>â‚¦${(i.price * i.qty).toLocaleString()}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="receipt-divider"></div>
                <div class="receipt-total">
                    <span>TOTAL</span>
                    <span>â‚¦${order.total.toLocaleString()}</span>
                </div>
                <div class="receipt-divider"></div>
                <div class="receipt-footer">
                    <p>Thank you for your patronage!</p>
                    <p style="font-weight: bold; margin-top: 10px;">Please call us on 321 to confirm your order</p>
                </div>
            `;
            
            modal.classList.add('open');
        }

        function closeReceiptModal() {
            document.getElementById('receipt-modal').classList.remove('open');
        }

        function downloadReceipt() {
            const element = document.getElementById('receipt-body');
            const opt = {
                margin: 10,
                filename: 'Sunshine_Hotel_Receipt.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        async function shareReceipt() {
            const element = document.getElementById('receipt-body');
            const opt = {
                margin: 10,
                filename: 'Sunshine_Hotel_Receipt.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            try {
                const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
                const file = new File([pdfBlob], "Sunshine_Hotel_Receipt.pdf", { type: "application/pdf" });

                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'Receipt', text: 'My receipt from Sunshine Hotel' });
                } else {
                    alert('Sharing is not supported on this device.');
                }
            } catch (e) { console.error(e); alert('Unable to share receipt.'); }
        }

        loadMenu();
    </script>
</body>
</html>